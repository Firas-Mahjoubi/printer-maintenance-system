<div class="container-fluid py-4">
  <!-- Success/Error Messages -->
  <div class="row justify-content-center mb-3" *ngIf="showSuccessMessage || showErrorMessage">
    <div class="col-lg-8 col-xl-6">
      <div class="alert alert-success border-0 shadow-sm" *ngIf="showSuccessMessage">
        <div class="d-flex align-items-center">
          <i class="bi bi-check-circle-fill me-3 fs-4"></i>
          <div>
            <strong>Succ√®s!</strong> Contrat cr√©√© avec succ√®s. Redirection en cours...
          </div>
        </div>
      </div>
      <div class="alert alert-danger border-0 shadow-sm" *ngIf="showErrorMessage">
        <div class="d-flex align-items-center">
          <i class="bi bi-exclamation-triangle-fill me-3 fs-4"></i>
          <div>
            <strong>Erreur!</strong> {{ errorMessage }}
          </div>
        </div>
      </div>
    </div>
  </div>

  <div class="row justify-content-center">
    <div class="col-lg-10 col-xl-8">
      <div class="card border-0 shadow-lg">
        <div class="card-header text-white py-4">
          <div class="d-flex align-items-center justify-content-between">
            <div class="d-flex align-items-center">
              <div class="bg-white bg-opacity-20 rounded-circle p-3 me-4">
                <i class="bi bi-file-earmark-text text-white fs-2"></i>
              </div>
              <div>
                <h3 class="mb-1 fw-bold">Nouveau Contrat de Maintenance</h3>
                <p class="mb-0 text-white-50">Cr√©er un nouveau contrat pour votre client</p>
              </div>
            </div>
            <div class="d-none d-md-block">
              <div class="bg-white bg-opacity-10 rounded-pill px-3 py-2">
                <small class="text-white fw-semibold">
                  <i class="bi bi-calendar me-1"></i>
                  {{ today | date:'dd/MM/yyyy' }}
                </small>
              </div>
            </div>
          </div>
        </div>
        
        <div class="card-body p-5">
          <!-- Enhanced Progress Indicator -->
          <div class="mb-5">
            <div class="d-flex justify-content-between align-items-center mb-3">
              <span class="fw-bold text-primary">Progression du formulaire</span>
              <span class="badge bg-primary px-3 py-2 rounded-pill">{{ getFormProgress() }}%</span>
            </div>
            <div class="progress mb-2" style="height: 10px;">
              <div class="progress-bar" 
                   role="progressbar" 
                   [style.width.%]="getFormProgress()" 
                   [attr.aria-valuenow]="getFormProgress()" 
                   aria-valuemin="0" 
                   aria-valuemax="100">
              </div>
            </div>
            <small class="text-muted">
              <i class="bi bi-info-circle me-1"></i>
              Compl√©tez tous les champs obligatoires pour activer la cr√©ation du contrat
            </small>
          </div>

          <form class="needs-validation" 
                #contratForm="ngForm" 
                (ngSubmit)="onSubmit(contratForm)" 
                novalidate>
            
            <!-- Section 1: Informations de base -->
            <div class="form-section">
              <h5 class="text-primary fw-bold mb-4 d-flex align-items-center">
                <div class="bg-primary text-white rounded-circle d-inline-flex align-items-center justify-content-center me-3 shadow" style="width: 40px; height: 40px;">
                  <i class="bi bi-1-circle"></i>
                </div>
                Informations de base
              </h5>
              
              <div class="row g-4">
                <div class="col-md-6">
                  <label for="numeroContrat" class="form-label">
                    <i class="bi bi-hash text-primary me-2"></i>
                    <span class="text-danger">*</span> Num√©ro du contrat
                  </label>
                  <div class="input-group">
                    <span class="input-group-text">
                      <i class="bi bi-tag text-primary"></i>
                    </span>
                    <input type="text" 
                           class="form-control" 
                           id="numeroContrat" 
                           required 
                           [(ngModel)]="contrat.numeroContrat" 
                           name="numeroContrat" 
                           #numeroContrat="ngModel"
                           placeholder="Ex: CONT-2025-001"
                           [class.is-valid]="numeroContrat.valid && numeroContrat.touched && !validationErrors.numeroContrat"
                           [class.is-invalid]="(numeroContrat.invalid && numeroContrat.touched) || validationErrors.numeroContrat">
                    <button type="button" 
                            class="btn btn-outline-secondary" 
                            (click)="generateContractNumber()"
                            title="G√©n√©rer un num√©ro automatique">
                      <i class="bi bi-arrow-clockwise"></i>
                    </button>
                  </div>
                  <div *ngIf="(numeroContrat.invalid && numeroContrat.touched) || validationErrors.numeroContrat" class="invalid-feedback d-block">
                    <i class="bi bi-exclamation-triangle me-2"></i>
                    {{ validationErrors.numeroContrat || 'Le num√©ro de contrat est obligatoire' }}
                  </div>
                  <div *ngIf="numeroContrat.valid && numeroContrat.touched && !validationErrors.numeroContrat" class="valid-feedback d-block">
                    <i class="bi bi-check-circle me-2"></i>
                    Num√©ro de contrat valide
                  </div>
                </div>

                <div class="col-md-6">
                  <label for="statutContrat" class="form-label">
                    <i class="bi bi-flag text-primary me-2"></i>
                    <span class="text-danger">*</span> Statut du contrat
                  </label>
                  <select class="form-select" 
                          id="statutContrat" 
                          required 
                          [(ngModel)]="contrat.statutContrat" 
                          name="statutContrat"
                          #statutContrat="ngModel"
                          [class.is-valid]="statutContrat.valid && statutContrat.touched && !validationErrors.statutContrat"
                          [class.is-invalid]="(statutContrat.invalid && statutContrat.touched) || validationErrors.statutContrat">
                    <option [ngValue]="null" disabled>S√©lectionner un statut...</option>
                    <option value="ACTIF">
                      üü¢ ACTIF - Contrat en cours d'ex√©cution
                    </option>
                    <option value="EN_ATTENTE">
                      üü° EN_ATTENTE - En attente de validation
                    </option>
                    <option value="BROUILLON">
                      üìù BROUILLON - En pr√©paration, non finalis√©
                    </option>
                    <option value="SUSPENDU">
                      ‚è∏Ô∏è SUSPENDU - Temporairement arr√™t√©
                    </option>
                  </select>
                  <div *ngIf="(statutContrat.invalid && statutContrat.touched) || validationErrors.statutContrat" class="invalid-feedback d-block">
                    <i class="bi bi-exclamation-triangle me-2"></i>
                    {{ validationErrors.statutContrat || 'Veuillez s√©lectionner un statut' }}
                  </div>
                  <div *ngIf="statutContrat.valid && statutContrat.touched && !validationErrors.statutContrat" class="valid-feedback d-block">
                    <i class="bi bi-check-circle me-2"></i>
                    Statut s√©lectionn√©
                  </div>
                </div>
              </div>
            </div>

            <!-- Section 2: P√©riode de validit√© -->
            <div class="form-section">
              <h5 class="text-primary fw-bold mb-4 d-flex align-items-center">
                <div class="bg-primary text-white rounded-circle d-inline-flex align-items-center justify-content-center me-3 shadow" style="width: 40px; height: 40px;">
                  <i class="bi bi-2-circle"></i>
                </div>
                P√©riode de validit√©
              </h5>
              
              <div class="row g-4">
                <div class="col-md-6">
                  <label for="dateDebut" class="form-label">
                    <i class="bi bi-calendar-event text-success me-2"></i>
                    <span class="text-danger">*</span> Date de d√©but
                  </label>
                  <div class="input-group">
                    <span class="input-group-text">
                      <i class="bi bi-play-circle text-success"></i>
                    </span>
                    <input type="date" 
                           class="form-control" 
                           id="dateDebut" 
                           required 
                           [(ngModel)]="contrat.dateDebut" 
                           name="dateDebut" 
                           #dateDebut="ngModel"
                           [min]="today"
                           [class.is-valid]="dateDebut.valid && dateDebut.touched && !validationErrors.dateDebut"
                           [class.is-invalid]="(dateDebut.invalid && dateDebut.touched) || validationErrors.dateDebut">
                  </div>
                  <div *ngIf="(dateDebut.invalid && dateDebut.touched) || validationErrors.dateDebut" class="invalid-feedback d-block">
                    <i class="bi bi-exclamation-triangle me-2"></i>
                    {{ validationErrors.dateDebut || 'La date de d√©but est obligatoire' }}
                  </div>
                  <div *ngIf="dateDebut.valid && dateDebut.touched && !validationErrors.dateDebut" class="valid-feedback d-block">
                    <i class="bi bi-check-circle me-2"></i>
                    Date de d√©but valide
                  </div>
                </div>

                <div class="col-md-6">
                  <label for="dateFin" class="form-label">
                    <i class="bi bi-calendar-x text-warning me-2"></i>
                    <span class="text-danger">*</span> Date de fin
                  </label>
                  <div class="input-group">
                    <span class="input-group-text">
                      <i class="bi bi-stop-circle text-warning"></i>
                    </span>
                    <input type="date" 
                           class="form-control" 
                           id="dateFin" 
                           required 
                           [(ngModel)]="contrat.dateFin" 
                           name="dateFin" 
                           #dateFin="ngModel"
                           [min]="contrat.dateDebut || today"
                           [class.is-valid]="dateFin.valid && dateFin.touched && !validationErrors.dateFin"
                           [class.is-invalid]="(dateFin.invalid && dateFin.touched) || validationErrors.dateFin">
                  </div>
                  <div *ngIf="(dateFin.invalid && dateFin.touched) || validationErrors.dateFin" class="invalid-feedback d-block">
                    <i class="bi bi-exclamation-triangle me-2"></i>
                    {{ validationErrors.dateFin || 'La date de fin est obligatoire' }}
                  </div>
                  <div *ngIf="dateFin.valid && dateFin.touched && !validationErrors.dateFin" class="valid-feedback d-block">
                    <i class="bi bi-check-circle me-2"></i>
                    Date de fin valide
                  </div>
                </div>
              </div>
              
              <!-- Enhanced Duration Display -->
              <div *ngIf="contrat.dateDebut && contrat.dateFin && calculateDuration() > 0" class="mt-4">
                <div class="alert alert-info border-0 shadow-sm">
                  <div class="d-flex align-items-center">
                    <i class="bi bi-clock text-info me-3 fs-4"></i>
                    <div>
                      <strong>Dur√©e du contrat:</strong> {{ formatDuration() }}
                      <div class="small text-muted mt-1">
                        <i class="bi bi-calendar-range me-1"></i>
                        Du {{ contrat.dateDebut | date:'dd/MM/yyyy' }} au {{ contrat.dateFin | date:'dd/MM/yyyy' }}
                      </div>
                    </div>
                  </div>
                </div>
              </div>
            </div>

            <!-- Section 3: Attribution du client -->
            <div class="form-section">
              <h5 class="text-primary fw-bold mb-4 d-flex align-items-center">
                <div class="bg-primary text-white rounded-circle d-inline-flex align-items-center justify-content-center me-3 shadow" style="width: 40px; height: 40px;">
                  <i class="bi bi-3-circle"></i>
                </div>
                Attribution du client
              </h5>
              
              <div class="row g-4" *ngIf="clients?.length; else noClientsMessage">
                <div class="col-md-8">
                  <label for="clientSearch" class="form-label">
                    <i class="bi bi-person-check text-success me-2"></i>
                    <span class="text-danger">*</span> Client assign√©
                  </label>
                  
                  <!-- Simplified Client Search -->
                  <div class="client-search-container">
                    <div class="input-group">
                      <span class="input-group-text">
                        <i class="bi bi-search text-success"></i>
                      </span>
                      <input type="text" 
                             class="form-control" 
                             id="clientSearch"
                             [(ngModel)]="clientSearchTerm"
                             name="clientSearch"
                             placeholder="Rechercher un client par nom, pr√©nom ou ID..."
                             (input)="onClientSearch()"
                             (focus)="onClientInputFocus()"
                             (blur)="onClientInputBlur()"
                             autocomplete="off"
                             [class.is-valid]="contrat.clientId && !validationErrors.clientId"
                             [class.is-invalid]="validationErrors.clientId">
                      <button type="button" 
                              class="btn btn-outline-secondary" 
                              *ngIf="clientSearchTerm"
                              (click)="clearClientSearch()"
                              title="Effacer la recherche">
                        <i class="bi bi-x"></i>
                      </button>
                    </div>
                    
                    <!-- Simplified Dropdown -->
                    <div class="client-dropdown" 
                         *ngIf="showClientDropdown"
                         [class.show]="showClientDropdown">
                      
                      <!-- Loading -->
                      <div class="dropdown-item" *ngIf="loadingClients">
                        <div class="d-flex align-items-center">
                          <div class="spinner-border spinner-border-sm text-primary me-3"></div>
                          <span>Chargement des clients...</span>
                        </div>
                      </div>
                      
                      <!-- Client List -->
                      <div *ngIf="!loadingClients">
                        <!-- Search Results Header -->
                        <div class="dropdown-header" *ngIf="clientSearchTerm">
                          <small class="text-muted">
                            {{ filteredClients.length }} r√©sultat(s) pour "{{ clientSearchTerm }}"
                          </small>
                        </div>
                        
                        <!-- Client Items -->
                        <div class="dropdown-item client-item" 
                             *ngFor="let client of filteredClients; let i = index; trackBy: trackByClientId"
                             (click)="selectClient(client)"
                             [class.selected]="contrat.clientId === client.id"
                             [class.highlighted]="i === highlightedIndex">
                          <div class="d-flex align-items-center">
                            <div class="client-avatar me-3">
                              <div class="rounded-circle bg-primary text-white d-flex align-items-center justify-content-center"
                                   style="width: 36px; height: 36px; font-size: 12px;">
                                {{ getClientInitials(client) }}
                              </div>
                            </div>
                            <div class="flex-grow-1">
                              <div class="fw-semibold">
                                {{ client.nom }} {{ client.prenom || '' }}
                                <span class="badge bg-light text-primary ms-2 small">#{{ client.id }}</span>
                              </div>
                              <small class="text-muted" *ngIf="client.email">
                                <i class="bi bi-envelope me-1"></i>{{ client.email }}
                              </small>
                            </div>
                            <div class="client-actions">
                              <i class="bi bi-check-circle text-success" *ngIf="contrat.clientId === client.id"></i>
                            </div>
                          </div>
                        </div>
                        
                        <!-- No Results -->
                        <div class="dropdown-item text-center" *ngIf="filteredClients.length === 0">
                          <div class="text-muted py-3">
                            <i class="bi bi-search fs-3 d-block mb-2 opacity-50"></i>
                            <div>Aucun client trouv√©</div>
                            <small>Essayez avec d'autres termes</small>
                          </div>
                        </div>
                        
                        <!-- Show All Button -->
                        <div class="dropdown-item border-top" *ngIf="!clientSearchTerm && clients.length > 10">
                          <button type="button" class="btn btn-link btn-sm w-100" (click)="showAllClients()">
                            Afficher tous les clients ({{ clients.length }})
                          </button>
                        </div>
                      </div>
                    </div>
                  </div>
                  
                  <!-- Hidden Input for Form Validation -->
                  <input type="hidden" 
                         [(ngModel)]="contrat.clientId" 
                         name="clientId"
                         #clientId="ngModel"
                         required>
                  
                  <!-- Validation Messages -->
                  <div *ngIf="validationErrors.clientId" class="invalid-feedback d-block">
                    <i class="bi bi-exclamation-triangle me-2"></i>
                    {{ validationErrors.clientId }}
                  </div>
                  <div *ngIf="contrat.clientId && !validationErrors.clientId" class="valid-feedback d-block">
                    <i class="bi bi-check-circle me-2"></i>
                    Client s√©lectionn√© avec succ√®s
                  </div>
                  
                  <!-- Quick Tips -->
                  <div class="form-text mt-2">
                    <i class="bi bi-lightbulb text-warning me-1"></i>
                    <small class="text-muted">
                      Tapez le nom, pr√©nom ou ID du client pour le rechercher rapidement
                    </small>
                  </div>
                </div>
                
                <!-- Selected Client Info -->
                <div class="col-md-4" *ngIf="getSelectedClient()">
                  <div class="card border-success bg-light h-100">
                    <div class="card-body p-3">
                      <h6 class="card-title text-success mb-2">
                        <i class="bi bi-person-check me-1"></i>
                        Client s√©lectionn√©
                      </h6>
                      <div class="small">
                        <div class="fw-bold">{{ getSelectedClient()?.nom }} {{ getSelectedClient()?.prenom || '' }}</div>
                        <div class="text-muted">ID: #{{ getSelectedClient()?.id }}</div>
                        <div class="text-muted" *ngIf="getSelectedClient()?.email">
                          <i class="bi bi-envelope me-1"></i>{{ getSelectedClient()?.email }}
                        </div>
                      </div>
                    </div>
                  </div>
                </div>
              </div>
              
              <ng-template #noClientsMessage>
                <div class="alert alert-warning border-0 shadow-sm">
                  <div class="d-flex align-items-center">
                    <i class="bi bi-exclamation-triangle-fill me-3 fs-4"></i>
                    <div>
                      <strong>Aucun client disponible</strong>
                      <div class="small mt-1">Veuillez ajouter des clients avant de cr√©er un contrat.</div>
                    </div>
                  </div>
                </div>
              </ng-template>
            </div>

            <!-- Section 4: Conditions d√©taill√©es -->
            <div class="form-section conditions-section">
              <h5 class="text-primary fw-bold mb-4 d-flex align-items-center">
                <div class="bg-primary text-white rounded-circle d-inline-flex align-items-center justify-content-center me-3 shadow" style="width: 40px; height: 40px;">
                  <i class="bi bi-4-circle"></i>
                </div>
                Conditions d√©taill√©es
              </h5>
              
              <div class="row g-4">
                <div class="col-12">
                  <label for="conditionsContrat" class="form-label">
                    <i class="bi bi-file-text text-info me-2"></i>
                    Conditions du contrat
                    <span class="text-muted small">(optionnel)</span>
                  </label>
                  <textarea
                    class="form-control"
                    id="conditionsContrat"
                    name="conditions_contrat"
                    [(ngModel)]="contrat.conditions_contrat"
                    rows="6"
                    placeholder="D√©crivez les conditions sp√©cifiques du contrat de maintenance...

Exemples :
‚Ä¢ Interventions pr√©ventives mensuelles
‚Ä¢ Support technique 24h/7j
‚Ä¢ Garantie sur les pi√®ces de rechange
‚Ä¢ D√©lai d'intervention : 4h maximum
‚Ä¢ Couverture g√©ographique
‚Ä¢ Conditions de renouvellement"
                    style="resize: vertical;">
                  </textarea>
                  <div class="form-text">
                    <div class="d-flex align-items-center">
                      <i class="bi bi-lightbulb text-warning me-2"></i>
                      <small class="text-muted">
                        <strong>Conseil :</strong> Soyez pr√©cis sur les services inclus, les d√©lais d'intervention et les garanties offertes.
                      </small>
                    </div>
                  </div>
                </div>
              </div>
            </div>

            <!-- Boutons d'action -->
            <div class="d-flex justify-content-between align-items-center pt-4 border-top">
              <button type="button" 
                      class="btn btn-outline-secondary"
                      (click)="cancel()">
                <i class="bi bi-arrow-left me-2"></i>
                Annuler
              </button>
              
              <div class="d-flex gap-2">
                <button type="button" 
                        class="btn btn-outline-primary"
                        [disabled]="isSubmitting"
                        (click)="saveDraft()">
                  <i class="bi bi-save me-2"></i>
                  Enregistrer comme brouillon
                </button>
                
                <button class="btn btn-success px-4" 
                        type="submit" 
                        [disabled]="contratForm.invalid || isSubmitting">
                  <i *ngIf="!isSubmitting" class="bi bi-check-circle me-2"></i>
                  <span *ngIf="isSubmitting" class="spinner-border spinner-border-sm me-2" role="status"></span>
                  {{ isSubmitting ? 'Enregistrement...' : 'Cr√©er le contrat' }}
                </button>
              </div>
            </div>

            <!-- Aide et informations -->
            <div class="mt-4 p-4 bg-light rounded">
              <div class="d-flex align-items-start">
                <i class="bi bi-info-circle text-primary me-3 fs-4"></i>
                <div>
                  <h6 class="mb-3 text-primary">Aide et conseils</h6>
                  <div class="row g-3">
                    <div class="col-md-6">
                      <ul class="small text-muted mb-0 ps-3">
                        <li>Les champs marqu√©s d'un <span class="text-danger">*</span> sont obligatoires</li>
                        <li>La date de fin doit √™tre post√©rieure √† la date de d√©but</li>
                        <li>Un contrat peut √™tre modifi√© apr√®s sa cr√©ation</li>
                      </ul>
                    </div>
                    <div class="col-md-6">
                      <ul class="small text-muted mb-0 ps-3">
                        <li>Les brouillons ne sont pas visibles par les clients</li>
                        <li>Le num√©ro de contrat est g√©n√©r√© automatiquement</li>
                        <li>Vos donn√©es sont sauvegard√©es automatiquement</li>
                      </ul>
                    </div>
                  </div>
                </div>
              </div>
            </div>
          </form>
        </div>
      </div>
    </div>
  </div>
</div>
