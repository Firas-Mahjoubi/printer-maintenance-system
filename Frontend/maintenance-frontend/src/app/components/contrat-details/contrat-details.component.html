<!-- Contrat Details Component -->
<div class="container-fluid py-4">
  <!-- Loading State -->
  <div class="row mb-4" *ngIf="loading">
    <div class="col-12">
      <div class="card border-0 shadow-sm">
        <div class="card-body text-center py-5">
          <div class="spinner-border text-primary" role="status">
            <span class="visually-hidden">Chargement...</span>
          </div>
          <p class="mt-3 text-muted">Chargement des détails du contrat...</p>
        </div>
      </div>
    </div>
  </div>

  <!-- Error State -->
  <div class="row mb-4" *ngIf="error && !loading">
    <div class="col-12">
      <div class="card border-0 shadow-sm border-danger">
        <div class="card-body text-center py-5">
          <i class="bi bi-exclamation-triangle text-danger error-icon"></i>
          <h4 class="mt-3 text-danger">Erreur</h4>
          <p class="text-muted">{{ error }}</p>
          <button class="btn btn-primary" (click)="loadContratDetails()">
            <i class="bi bi-arrow-clockwise me-2"></i>Réessayer
          </button>
        </div>
      </div>
    </div>
  </div>

  <!-- Header Section -->
  <div class="row mb-4" *ngIf="contrat && !loading">
    <div class="col-12">
      <div class="card border-0 shadow-lg glass-card animate-slide-in-bottom">
        <div class="card-body p-4">
          <div class="d-flex justify-content-between align-items-start flex-wrap gap-3">
            <div class="d-flex align-items-center flex-wrap gap-3">
              <button class="btn btn-light btn-enhanced rounded-pill shadow-sm" (click)="goBack()">
                <i class="bi bi-arrow-left me-1"></i> Retour
              </button>
              <div class="text-dark">
                <div class="d-flex align-items-center mb-2">
                  <div class="me-3 p-3 rounded-circle bg-gradient-primary text-white shadow-lg">
                    <i class="bi bi-file-earmark-text fs-2"></i>
                  </div>
                  <div>
                    <h1 class="h2 mb-1 fw-bold text-primary">Contrat #{{ contrat.numeroContrat }}</h1>
                    <p class="mb-0 text-muted">Détails complets du contrat de maintenance</p>
                  </div>
                </div>
                <div class="d-flex align-items-center gap-3 flex-wrap">
                  <span class="badge bg-light text-primary px-3 py-2 rounded-pill animated-badge">
                    <i class="bi bi-calendar me-1"></i>
                    {{ calculateContractDuration(contrat.dateDebut, contrat.dateFin) }}
                  </span>
                  <div class="status-indicator" [ngClass]="'status-' + getContractStatusInfo().color">
                    <i [ngClass]="getContractStatusInfo().icon"></i>
                    {{ getContractStatusInfo().text }}
                  </div>
                  <span class="badge bg-info text-white px-3 py-2 rounded-pill animated-badge">
                    <i class="bi bi-printer me-1"></i>
                    {{ imprimantes.length }} imprimante{{ imprimantes.length > 1 ? 's' : '' }}
                  </span>
                </div>
              </div>
            </div>
            <div class="d-flex gap-2 align-items-center flex-wrap">
              <div class="btn-group shadow-lg" role="group">
                <button class="btn btn-outline-warning btn-enhanced" (click)="editContrat()">
                  <i class="bi bi-pencil"></i>
                  <span class="d-none d-md-inline ms-1">Modifier</span>
                </button>
                <button class="btn btn-success btn-enhanced" 
                        (click)="toggleRenewalForm()" 
                        *ngIf="isContractRenewable()"
                        [disabled]="showRenewalForm">
                  <i class="bi bi-arrow-clockwise"></i>
                  <span class="d-none d-md-inline ms-1">Renouveler</span>
                </button>
              </div>
              <div class="dropdown">
                <button class="btn btn-primary btn-enhanced dropdown-toggle shadow-sm" 
                        data-bs-toggle="dropdown"
                        [disabled]="exportingPdf">
                  <span *ngIf="exportingPdf" class="spinner-border spinner-border-sm me-2" role="status"></span>
                  <i class="bi bi-download me-2" *ngIf="!exportingPdf"></i>
                  {{ exportingPdf ? 'Export...' : 'Actions' }}
                </button>
                <ul class="dropdown-menu dropdown-menu-end shadow-lg">
                  <li>
                    <h6 class="dropdown-header">
                      <i class="bi bi-file-earmark-pdf me-2"></i>
                      Export & Actions
                    </h6>
                  </li>
                  <li>
                    <a class="dropdown-item" (click)="exportToPdf()" [class.disabled]="exportingPdf">
                      <i class="bi bi-file-earmark-pdf me-2 text-danger"></i>
                      <div>
                        <div class="fw-semibold">Contrat complet PDF</div>
                        <small class="text-muted">PDF avec toutes les informations</small>
                      </div>
                    </a>
                  </li>
                  <li>
                    <a class="dropdown-item" (click)="exportEquipmentList()" [class.disabled]="exportingPdf">
                      <i class="bi bi-printer me-2 text-success"></i>
                      <div>
                        <div class="fw-semibold">Liste équipements</div>
                        <small class="text-muted">PDF des imprimantes uniquement</small>
                      </div>
                    </a>
                  </li>
                  <li><hr class="dropdown-divider"></li>
                  <li><a class="dropdown-item" href="#"><i class="bi bi-files me-2"></i> Dupliquer contrat</a></li>
                  <li><a class="dropdown-item text-danger" (click)="deleteContrat()"><i class="bi bi-trash me-2"></i> Supprimer</a></li>
                </ul>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <div class="row" *ngIf="contrat && !loading">
    <!-- Main Content -->
    <div class="col-lg-8">
      <!-- Contract Overview -->
      <div class="card border-0 shadow-lg mb-4 overflow-hidden animate-slide-in-left">
        <div class="card-header bg-gradient-primary text-white border-0 position-relative">
          <h5 class="mb-0 fw-semibold d-flex align-items-center">
            <i class="bi bi-file-earmark-text me-2"></i>
            Informations Générales
          </h5>
          <div class="position-absolute top-0 end-0 p-3">
            <i class="bi bi-shield-check opacity-25" style="font-size: 2rem;"></i>
          </div>
        </div>
        <div class="card-body p-4">
          <div class="row g-4 stagger-animation">
            <div class="col-md-6">
              <div class="info-item">
                <div class="d-flex align-items-center mb-3">
                  <div class="p-2 rounded-circle bg-primary text-white me-3">
                    <i class="bi bi-hash"></i>
                  </div>
                  <div>
                    <label class="form-label text-primary small fw-bold mb-1">NUMÉRO DE CONTRAT</label>
                    <div class="fw-bold text-dark fs-4">{{ contrat.numeroContrat }}</div>
                    <small class="text-muted">Identifiant unique</small>
                  </div>
                </div>
              </div>
            </div>
            <div class="col-md-6">
              <div class="info-item">
                <div class="d-flex align-items-center mb-3">
                  <div class="p-2 rounded-circle bg-success text-white me-3">
                    <i class="bi bi-check-circle"></i>
                  </div>
                  <div>
                    <label class="form-label text-success small fw-bold mb-2">STATUT</label>
                    <div class="mb-2">
                      <div class="status-indicator" [ngClass]="'status-' + getContractStatusInfo().color">
                        <i [ngClass]="getContractStatusInfo().icon"></i>
                        {{ getContractStatusInfo().text }}
                      </div>
                    </div>
                    <small class="text-muted">État actuel</small>
                  </div>
                </div>
              </div>
            </div>
            <div class="col-md-6">
              <div class="info-item">
                <div class="d-flex align-items-center mb-3">
                  <div class="p-2 rounded-circle bg-info text-white me-3">
                    <i class="bi bi-calendar-event"></i>
                  </div>
                  <div>
                    <label class="form-label text-info small fw-bold mb-2">DATE DE DÉBUT</label>
                    <div class="fw-semibold fs-5 mb-1">{{ formatDate(contrat.dateDebut) }}</div>
                    <small class="text-muted">{{ formatDateShort(contrat.dateDebut) }}</small>
                  </div>
                </div>
              </div>
            </div>
            <div class="col-md-6">
              <div class="info-item">
                <div class="d-flex align-items-center mb-3">
                  <div class="p-2 rounded-circle bg-warning text-white me-3">
                    <i class="bi bi-calendar-x"></i>
                  </div>
                  <div>
                    <label class="form-label text-warning small fw-bold mb-2">DATE DE FIN</label>
                    <div class="fw-semibold fs-5 mb-2">{{ formatDate(contrat.dateFin) }}</div>
                    <div *ngIf="calculateDaysRemaining(contrat.dateFin) > 0">
                      <span class="badge bg-warning text-dark animated-badge">
                        <i class="bi bi-clock me-1"></i>
                        {{ calculateDaysRemaining(contrat.dateFin) }} jours restants
                      </span>
                    </div>
                    <div *ngIf="calculateDaysRemaining(contrat.dateFin) <= 0">
                      <span class="badge bg-danger animated-badge">
                        <i class="bi bi-exclamation-triangle me-1"></i>
                        Contrat expiré
                      </span>
                    </div>
                  </div>
                </div>
              </div>
            </div>
            <div class="col-md-6">
              <div class="info-item">
                <div class="d-flex align-items-center mb-3">
                  <div class="p-2 rounded-circle text-white me-3" style="background: linear-gradient(135deg, #6f42c1, #e83e8c);">
                    <i class="bi bi-clock-history"></i>
                  </div>
                  <div>
                    <label class="form-label small fw-bold mb-2" style="color: #6f42c1;">DURÉE</label>
                    <div class="fw-semibold fs-5 mb-1">{{ calculateContractDuration(contrat.dateDebut, contrat.dateFin) }}</div>
                    <small class="text-muted">Période totale</small>
                  </div>
                </div>
              </div>
            </div>
            <div class="col-md-6">
              <div class="info-item">
                <div class="d-flex align-items-center mb-3">
                  <div class="p-2 rounded-circle bg-secondary text-white me-3">
                    <i class="bi bi-tools"></i>
                  </div>
                  <div>
                    <label class="form-label text-secondary small fw-bold mb-2">TYPE DE CONTRAT</label>
                    <div class="fw-semibold fs-5 mb-1">Maintenance Préventive</div>
                    <small class="text-muted">Contrat standard</small>
                  </div>
                </div>
              </div>
            </div>
          </div>
          
          <!-- Enhanced Progress Section -->
          <div class="mt-5 p-4 glass-card">
            <div class="d-flex justify-content-between align-items-center mb-3">
              <div>
                <h6 class="fw-bold text-dark mb-1">Progression du contrat</h6>
                <small class="text-muted">Pourcentage d'avancement de la période contractuelle</small>
              </div>
              <div class="stats-number" style="font-size: 2rem;">{{ getProgressPercentage(contrat.dateDebut, contrat.dateFin) }}%</div>
            </div>
            <div class="progress mb-3" style="height: 12px; border-radius: 10px;">
              <div class="progress-bar" 
                   style="background: linear-gradient(90deg, #007bff, #28a745);"
                   role="progressbar" 
                   [style.width.%]="getProgressPercentage(contrat.dateDebut, contrat.dateFin)"
                   [attr.aria-valuenow]="getProgressPercentage(contrat.dateDebut, contrat.dateFin)"
                   aria-valuemin="0" 
                   aria-valuemax="100">
              </div>
            </div>
            <div class="row text-center">
              <div class="col-4">
                <div class="fw-bold text-primary">{{ formatDate(contrat.dateDebut).split(' ')[0] }}</div>
                <small class="text-muted">Début</small>
              </div>
              <div class="col-4">
                <div class="fw-bold text-success">{{ calculateDaysRemaining(contrat.dateFin) > 0 ? calculateDaysRemaining(contrat.dateFin) : 0 }}</div>
                <small class="text-muted">Jours restants</small>
              </div>
              <div class="col-4">
                <div class="fw-bold text-warning">{{ formatDate(contrat.dateFin).split(' ')[0] }}</div>
                <small class="text-muted">Fin</small>
              </div>
            </div>
          </div>
        </div>
      </div>

      <!-- Client Information -->
      <div class="card border-0 shadow-lg mb-4 overflow-hidden animate-slide-in-right">
        <div class="card-header bg-gradient-info text-white border-0 position-relative">
          <h5 class="mb-0 fw-semibold d-flex align-items-center">
            <i class="bi bi-building me-2"></i>
            Informations Client
          </h5>
          <div class="position-absolute top-0 end-0 p-3">
            <i class="bi bi-person-badge opacity-25" style="font-size: 2rem;"></i>
          </div>
        </div>
        <div class="card-body p-4">
          <div class="row align-items-center mb-4">
            <div class="col-auto">
              <div class="progress-circle-container">
                <div class="progress-circle-bg"></div>
                <div class="avatar-xl text-white rounded-circle d-flex align-items-center justify-content-center shadow-lg progress-circle-content">
                  <span class="fs-2 fw-bold">{{ getClientInitials() }}</span>
                </div>
              </div>
            </div>
            <div class="col">
              <h3 class="mb-2 fw-bold text-dark">{{ getClientDisplayInfo().name }}</h3>
              <div class="d-flex align-items-center gap-3 flex-wrap">
                <span class="badge bg-success px-3 py-2 rounded-pill animated-badge">
                  <i class="bi bi-person-check me-1"></i>
                  Client Actif
                </span>
                <span class="text-muted d-flex align-items-center">
                  <i class="bi bi-hash me-1"></i>
                  ID: {{ getClientDisplayInfo().id }}
                </span>
                <span class="badge bg-info px-3 py-2 rounded-pill animated-badge">
                  <i class="bi bi-calendar me-1"></i>
                  Depuis {{ getContractYear() }}
                </span>
              </div>
            </div>
          </div>
          
          <div class="row g-4 stagger-animation">
            <div class="col-md-6">
              <div class="contact-item glass-card">
                <div class="d-flex align-items-center mb-3">
                  <div class="icon-wrapper bg-gradient-primary text-white rounded-circle me-3 shadow-sm">
                    <i class="bi bi-person-circle"></i>
                  </div>
                  <div>
                    <strong class="text-dark">Nom Complet</strong>
                    <div class="text-muted small">Information personnelle</div>
                  </div>
                </div>
                <div class="ps-5">
                  <div class="fw-semibold text-dark fs-5">{{ getClientDisplayInfo().name }}</div>
                  <small class="text-muted">Titulaire du contrat</small>
                </div>
              </div>
            </div>
            <div class="col-md-6">
              <div class="contact-item glass-card">
                <div class="d-flex align-items-center mb-3">
                  <div class="icon-wrapper bg-gradient-danger text-white rounded-circle me-3 shadow-sm">
                    <i class="bi bi-envelope"></i>
                  </div>
                  <div>
                    <strong class="text-dark">Email</strong>
                    <div class="text-muted small">Contact principal</div>
                  </div>
                </div>
                <div class="ps-5">
                  <a href="mailto:{{ getClientDisplayInfo().email }}" 
                     class="text-decoration-none fw-semibold text-primary">
                    {{ getClientDisplayInfo().email }}
                  </a>
                  <div class="mt-1">
                    <small class="text-success">
                      <i class="bi bi-check-circle me-1"></i>
                      Email vérifié
                    </small>
                  </div>
                </div>
              </div>
            </div>
            <div class="col-md-6">
              <div class="contact-item glass-card">
                <div class="d-flex align-items-center mb-3">
                  <div class="icon-wrapper bg-gradient-success text-white rounded-circle me-3 shadow-sm">
                    <i class="bi bi-telephone"></i>
                  </div>
                  <div>
                    <strong class="text-dark">Téléphone</strong>
                    <div class="text-muted small">Contact rapide</div>
                  </div>
                </div>
                <div class="ps-5">
                  <a href="tel:{{ getClientDisplayInfo().phone }}" 
                     class="text-decoration-none fw-semibold text-success">
                    {{ getClientDisplayInfo().phone }}
                  </a>
                  <div class="mt-1">
                    <button class="btn btn-outline-success btn-sm">
                      <i class="bi bi-telephone me-1"></i>
                      Appeler
                    </button>
                  </div>
                </div>
              </div>
            </div>
            <div class="col-md-6">
              <div class="contact-item glass-card">
                <div class="d-flex align-items-center mb-3">
                  <div class="icon-wrapper bg-gradient-warning text-white rounded-circle me-3 shadow-sm">
                    <i class="bi bi-hash"></i>
                  </div>
                  <div>
                    <strong class="text-dark">Identifiant Client</strong>
                    <div class="text-muted small">Référence interne</div>
                  </div>
                </div>
                <div class="ps-5">
                  <code class="bg-light px-3 py-2 rounded fs-6 fw-semibold">#{{ getClientDisplayInfo().id }}</code>
                  <div class="mt-2">
                    <button class="btn btn-outline-secondary btn-sm">
                      <i class="bi bi-clipboard me-1"></i>
                      Copier
                    </button>
                  </div>
                </div>
              </div>
            </div>
          </div>

          <!-- Client Statistics -->
          <div class="mt-4 p-4 glass-card">
            <h6 class="fw-bold mb-3 text-dark">
              <i class="bi bi-graph-up me-2"></i>
              Statistiques Client
            </h6>
            <div class="row text-center">
              <div class="col-md-3 col-6 mb-3">
                <div class="stats-number">1</div>
                <div class="stats-label">Contrat Actif</div>
              </div>
              <div class="col-md-3 col-6 mb-3">
                <div class="stats-number">{{ imprimantes.length }}</div>
                <div class="stats-label">Équipements</div>
              </div>
              <div class="col-md-3 col-6 mb-3">
                <div class="stats-number">{{ calculateDaysRemaining(contrat.dateFin) > 0 ? calculateDaysRemaining(contrat.dateFin) : 0 }}</div>
                <div class="stats-label">Jours Restants</div>
              </div>
              <div class="col-md-3 col-6 mb-3">
                <div class="stats-number">{{ getProgressPercentage(contrat.dateDebut, contrat.dateFin) }}%</div>
                <div class="stats-label">Progression</div>
              </div>
            </div>
          </div>
        </div>
      </div>

      <!-- Contract Renewal Form -->
      <div class="card border-0 shadow-lg mb-4 renewal-card" *ngIf="showRenewalForm">
        <div class="card-header bg-gradient-success text-white border-0 position-relative">
          <div class="d-flex justify-content-between align-items-center">
            <div>
              <h5 class="mb-1 fw-bold d-flex align-items-center">
                <i class="bi bi-arrow-clockwise me-2"></i>
                Renouvellement de Contrat
              </h5>
              <small class="opacity-75">Créer un nouveau contrat basé sur l'actuel</small>
            </div>
            <button class="btn btn-light btn-sm rounded-circle" (click)="cancelRenewal()" [disabled]="renewalLoading">
              <i class="bi bi-x"></i>
            </button>
          </div>
          <div class="position-absolute top-0 end-0 p-3">
            <i class="bi bi-arrow-repeat opacity-25" style="font-size: 3rem;"></i>
          </div>
        </div>
        <div class="card-body p-4">
          <div class="alert alert-info border-0 bg-info-subtle">
            <div class="d-flex align-items-start">
              <i class="bi bi-info-circle me-3 text-info fs-4"></i>
              <div>
                <strong class="text-info">Information importante:</strong>
                <p class="mb-2">Le renouvellement créera un nouveau contrat et changera le statut de l'ancien contrat en "Renouvelé".</p>
                <ul class="mb-0 text-muted small">
                  <li>Les imprimantes seront automatiquement transférées vers le nouveau contrat</li>
                  <li>L'historique du contrat précédent sera conservé</li>
                  <li>Une nouvelle période de facturation débutera</li>
                </ul>
              </div>
            </div>
          </div>
          
          <form (ngSubmit)="renewContract()" #renewalForm="ngForm">
            <div class="row g-4">
              <div class="col-md-6">
                <div class="form-floating mb-3">
                  <input type="text" 
                         class="form-control form-control-lg" 
                         id="renewalNumeroContrat" 
                         [(ngModel)]="renewalContrat.numeroContrat" 
                         name="renewalNumeroContrat"
                         placeholder="Ex: CONT-2025-001"
                         required>
                  <label for="renewalNumeroContrat">
                    Numéro du Nouveau Contrat <span class="text-danger">*</span>
                  </label>
                  <div class="form-text">
                    <i class="bi bi-lightbulb text-warning me-1"></i>
                    Suggestion basée sur l'ancien contrat
                  </div>
                </div>
              </div>
              
              <div class="col-md-6">
                <div class="form-floating mb-3">
                  <input type="text" 
                         class="form-control form-control-lg" 
                         id="renewalClientId" 
                         [value]="getClientDisplayInfo().name" 
                         readonly>
                  <label for="renewalClientId">Client</label>
                  <div class="form-text">
                    <i class="bi bi-lock text-muted me-1"></i>
                    Client automatiquement sélectionné
                  </div>
                </div>
              </div>
              
              <div class="col-md-6">
                <div class="form-floating mb-3">
                  <input type="date" 
                         class="form-control form-control-lg" 
                         id="renewalDateDebut" 
                         [(ngModel)]="renewalContrat.dateDebut" 
                         name="renewalDateDebut"
                         required>
                  <label for="renewalDateDebut">
                    Date de Début <span class="text-danger">*</span>
                  </label>
                  <div class="form-text">
                    <i class="bi bi-calendar text-primary me-1"></i>
                    Date de début du nouveau contrat
                  </div>
                </div>
              </div>
              
              <div class="col-md-6">
                <div class="form-floating mb-3">
                  <input type="date" 
                         class="form-control form-control-lg" 
                         id="renewalDateFin" 
                         [(ngModel)]="renewalContrat.dateFin" 
                         name="renewalDateFin"
                         required>
                  <label for="renewalDateFin">
                    Date de Fin <span class="text-danger">*</span>
                  </label>
                  <div class="form-text">
                    <i class="bi bi-calendar-check text-success me-1"></i>
                    Date de fin calculée automatiquement
                  </div>
                </div>
              </div>
              
              <div class="col-12">
                <div class="form-floating mb-3">
                  <textarea class="form-control" 
                            id="renewalConditions" 
                            [(ngModel)]="renewalContrat.conditions_contrat" 
                            name="renewalConditions"
                            style="height: 120px"
                            placeholder="Conditions et termes du contrat renouvelé..."></textarea>
                  <label for="renewalConditions">Conditions du Contrat</label>
                  <div class="form-text">
                    <i class="bi bi-file-text text-info me-1"></i>
                    Modifiez les conditions si nécessaire
                  </div>
                </div>
              </div>
            </div>
            
            <!-- Renewal Summary -->
            <div class="card bg-gradient-light border-0 mt-4">
              <div class="card-body p-4">
                <h6 class="fw-bold mb-4 d-flex align-items-center text-dark">
                  <i class="bi bi-list-check me-2 text-primary"></i>
                  Résumé du Renouvellement
                </h6>
                <div class="row g-4">
                  <div class="col-md-6">
                    <div class="summary-item border-start border-4 border-danger ps-3">
                      <small class="text-muted fw-semibold">ANCIEN CONTRAT</small>
                      <div class="fw-bold text-dark fs-5 mb-1">{{ contrat.numeroContrat }}</div>
                      <div class="d-flex align-items-center gap-2">
                        <span class="badge bg-secondary">{{ getStatusText(contrat.statutContrat) }}</span>
                        <i class="bi bi-arrow-right text-muted"></i>
                        <span class="badge bg-warning">Renouvelé</span>
                      </div>
                    </div>
                  </div>
                  <div class="col-md-6">
                    <div class="summary-item border-start border-4 border-success ps-3">
                      <small class="text-muted fw-semibold">NOUVEAU CONTRAT</small>
                      <div class="fw-bold text-dark fs-5 mb-1">{{ renewalContrat.numeroContrat || 'À définir' }}</div>
                      <span class="badge bg-success">
                        <i class="bi bi-check-circle me-1"></i>
                        Actif
                      </span>
                    </div>
                  </div>
                </div>
                <div class="mt-4 p-3 bg-white rounded border">
                  <div class="d-flex align-items-center justify-content-between">
                    <div class="d-flex align-items-center">
                      <i class="bi bi-printer text-primary fs-4 me-3"></i>
                      <div>
                        <div class="fw-semibold text-dark">Transfert d'équipements</div>
                        <small class="text-muted">Migration automatique</small>
                      </div>
                    </div>
                    <span class="badge bg-primary px-3 py-2 rounded-pill">
                      {{ imprimantes.length }} imprimante(s)
                    </span>
                  </div>
                </div>
              </div>
            </div>
            
            <div class="d-flex justify-content-end gap-3 mt-4 pt-3 border-top">
              <button type="button" 
                      class="btn btn-outline-secondary btn-lg px-4" 
                      (click)="cancelRenewal()"
                      [disabled]="renewalLoading">
                <i class="bi bi-x-circle me-2"></i>
                Annuler
              </button>
              <button type="submit" 
                      class="btn btn-success btn-lg px-4 shadow-sm" 
                      [disabled]="renewalLoading || !renewalForm.valid">
                <span *ngIf="renewalLoading" class="spinner-border spinner-border-sm me-2" role="status"></span>
                <i class="bi bi-arrow-clockwise me-2" *ngIf="!renewalLoading"></i>
                {{ renewalLoading ? 'Renouvellement en cours...' : 'Renouveler le Contrat' }}
              </button>
            </div>
          </form>
        </div>
      </div>

      <!-- Contract Content -->
      <div class="card border-0 shadow-sm mb-4" *ngIf="contrat.conditions_contrat">
        <div class="card-header bg-warning text-dark border-0">
          <h5 class="mb-0 fw-semibold">
            <i class="bi bi-file-text me-2"></i>
            Contenu du Contrat
          </h5>
        </div>
        <div class="card-body">
          <div class="contract-content" [innerHTML]="contrat.conditions_contrat">
          </div>
        </div>
      </div>

      <!-- Compact Printers Summary -->
      <div class="card border-0 shadow-lg mb-4 equipment-summary-card animate-slide-in-bottom" 
           (click)="goToPrintersManagement()" 
           style="cursor: pointer;" 
           role="button" 
           tabindex="0"
           (keydown.enter)="goToPrintersManagement()"
           (keydown.space)="goToPrintersManagement()">
        <div class="card-header bg-gradient-primary text-white border-0">
          <div class="d-flex justify-content-between align-items-center">
            <div>
              <h5 class="mb-1 fw-semibold d-flex align-items-center">
                <i class="bi bi-printer me-2"></i>
                Équipements Assignés
                <span class="badge bg-white bg-opacity-20 text-white ms-3 px-3 py-2 rounded-pill">{{ imprimantes.length }}</span>
              </h5>
              <small class="opacity-75">Résumé des imprimantes sous contrat - Cliquez pour la gestion complète</small>
            </div>
            <div class="d-flex gap-2">
              <button class="btn btn-light btn-enhanced" (click)="refreshImprimantes()" [disabled]="loadingImprimantes">
                <i class="bi bi-arrow-clockwise me-1" [ngClass]="{'spin': loadingImprimantes}"></i>
                Actualiser
              </button>
              <button class="btn btn-primary btn-enhanced" (click)="goToPrintersManagement()">
                <i class="bi bi-gear me-1"></i>
                Gérer
              </button>
            </div>
          </div>
        </div>
        <div class="card-body p-4">
          <!-- Loading State -->
          <div class="text-center py-4" *ngIf="loadingImprimantes">
            <div class="spinner-border text-primary" role="status">
              <span class="visually-hidden">Chargement...</span>
            </div>
            <p class="mt-3 text-muted mb-0">Chargement des imprimantes...</p>
          </div>

          <!-- Error State -->
          <div class="alert alert-warning border-0 mb-0" *ngIf="errorImprimantes && !loadingImprimantes">
            <div class="d-flex align-items-center">
              <i class="bi bi-exclamation-triangle me-3 fs-4"></i>
              <div class="flex-grow-1">
                <strong>Erreur de chargement</strong>
                <p class="mb-0">{{ errorImprimantes }}</p>
              </div>
              <button class="btn btn-outline-warning btn-enhanced" (click)="refreshImprimantes()">
                <i class="bi bi-arrow-clockwise me-1"></i>Réessayer
              </button>
            </div>
          </div>

          <!-- Empty State -->
          <div class="text-center py-4" *ngIf="!loadingImprimantes && !errorImprimantes && imprimantes.length === 0">
            <div class="mb-3">
              <i class="bi bi-printer text-muted" style="font-size: 3rem; opacity: 0.3;"></i>
            </div>
            <h6 class="text-muted mb-3">Aucune imprimante assignée</h6>
            <p class="text-muted mb-4">Ce contrat n'a aucune imprimante assignée pour le moment.</p>
            <button class="btn btn-primary btn-enhanced" (click)="goToPrintersManagement()">
              <i class="bi bi-plus-circle me-2"></i>Ajouter des imprimantes
            </button>
          </div>

          <!-- Printers Summary -->
          <div *ngIf="!loadingImprimantes && !errorImprimantes && imprimantes.length > 0">
            <!-- Statistics Row -->
            <div class="equipment-stats-grid">
              <div class="equipment-stat-item primary">
                <div class="fw-bold text-primary fs-4">{{ imprimantes.length }}</div>
                <small class="text-muted">Total</small>
              </div>
              <div class="equipment-stat-item success">
                <div class="fw-bold text-success fs-4">{{ getOperationalCount() }}</div>
                <small class="text-muted">Opérationnels</small>
              </div>
              <div class="equipment-stat-item info">
                <div class="fw-bold text-info fs-4">{{ getBrandsCount() }}</div>
                <small class="text-muted">Marques</small>
              </div>
              <div class="equipment-stat-item warning">
                <div class="fw-bold text-warning fs-4">{{ getLocationsCount() }}</div>
                <small class="text-muted">Emplacements</small>
              </div>
            </div>

            <!-- Recent Printers Preview -->
            <div class="mb-4">
              <h6 class="fw-semibold mb-3 d-flex align-items-center">
                <i class="bi bi-list-ul me-2"></i>Aperçu des équipements
                <span class="badge bg-light text-dark ms-2">{{ Math.min(imprimantes.length, 3) }} sur {{ imprimantes.length }}</span>
              </h6>
              <div class="row g-3">
                <div class="col-lg-4 col-md-6" *ngFor="let imprimante of imprimantes.slice(0, 3)">
                  <div class="card border-0 equipment-preview-card h-100">
                    <div class="card-body p-3">
                      <div class="d-flex align-items-start">
                        <div class="me-3 p-2 rounded bg-primary bg-opacity-10">
                          <i class="bi bi-printer text-primary"></i>
                        </div>
                        <div class="flex-grow-1 min-w-0">
                          <div class="fw-semibold text-truncate">{{ imprimante.marque }}</div>
                          <div class="text-muted small text-truncate">{{ imprimante.modele }}</div>
                          <div class="text-muted small text-truncate">
                            <i class="bi bi-geo-alt me-1"></i>{{ imprimante.emplacement || 'Non défini' }}
                          </div>
                          <div class="mt-2">
                            <span class="badge bg-success-subtle text-success">
                              <i class="bi bi-check-circle me-1"></i>Opérationnel
                            </span>
                          </div>
                        </div>
                      </div>
                    </div>
                  </div>
                </div>
              </div>
            </div>

            <!-- Action Buttons -->
            <div class="d-flex justify-content-between align-items-center">
              <div class="text-muted small">
                <i class="bi bi-info-circle me-1"></i>
                <span *ngIf="imprimantes.length > 3">{{ imprimantes.length - 3 }} équipement(s) supplémentaire(s) disponible(s)</span>
                <span *ngIf="imprimantes.length <= 3">Tous les équipements affichés</span>
              </div>
              <div class="d-flex gap-2">
                <button class="equipment-nav-button" (click)="goToPrintersManagement()">
                  <i class="bi bi-list me-2"></i>Gérer tout ({{ imprimantes.length }})
                </button>
                <button class="btn btn-outline-info btn-enhanced" (click)="exportEquipmentList()" [disabled]="exportingPdf">
                  <span *ngIf="exportingPdf" class="spinner-border spinner-border-sm me-2" role="status"></span>
                  <i class="bi bi-download me-2" *ngIf="!exportingPdf"></i>
                  {{ exportingPdf ? 'Export...' : 'Exporter' }}
                </button>
              </div>
            </div>
          </div>
        </div>
      </div>

    </div>

    <!-- Enhanced Sidebar -->
    <div class="col-lg-4">
      <!-- Contract Status Card -->
      <div class="stats-card mb-4 animate-slide-in-right">
        <div class="card-body text-center">
          <div class="position-relative mb-4">
            <div class="progress-circle-container mx-auto">
              <div class="progress-circle-bg"></div>
              <div class="progress-circle mx-auto progress-circle-lg progress-circle-content">
                <svg width="140" height="140" viewBox="0 0 140 140">
                  <circle cx="70" cy="70" r="60" fill="none" stroke="#e9ecef" stroke-width="10"/>
                  <circle cx="70" cy="70" r="60" fill="none" stroke="url(#progressGradient)" stroke-width="10" 
                          [attr.stroke-dasharray]="377" 
                          [attr.stroke-dashoffset]="377 - (377 * getProgressPercentage(contrat.dateDebut, contrat.dateFin) / 100)"
                          transform="rotate(-90 70 70)" stroke-linecap="round"/>
                  <defs>
                    <linearGradient id="progressGradient" x1="0%" y1="0%" x2="100%" y2="0%">
                      <stop offset="0%" style="stop-color:#007bff;stop-opacity:1" />
                      <stop offset="100%" style="stop-color:#28a745;stop-opacity:1" />
                    </linearGradient>
                  </defs>
                </svg>
                <div class="position-absolute top-50 start-50 translate-middle text-center">
                  <div class="stats-number mb-0" style="font-size: 2.5rem;">{{ getProgressPercentage(contrat.dateDebut, contrat.dateFin) }}%</div>
                  <small class="text-muted fw-semibold">PROGRESSION</small>
                </div>
              </div>
            </div>
          </div>
          
          <div class="status-indicator mb-4" [ngClass]="'status-' + getContractStatusInfo().color">
            <i [ngClass]="getContractStatusInfo().icon"></i>
            {{ getContractStatusInfo().text }}
          </div>
          
          <div class="row text-center g-3">
            <div class="col-6">
              <div class="glass-card p-3">
                <div class="stats-number mb-1" style="font-size: 1.8rem;">{{ contrat.id || 'N/A' }}</div>
                <div class="stats-label">ID Contrat</div>
              </div>
            </div>
            <div class="col-6">
              <div class="glass-card p-3">
                <div class="stats-number mb-1" style="font-size: 1.8rem;">{{ contrat.client?.id || contrat.clientId || 'N/A' }}</div>
                <div class="stats-label">ID Client</div>
              </div>
            </div>
            <div class="col-6">
              <div class="glass-card p-3">
                <div class="stats-number mb-1" style="font-size: 1.8rem;">{{ imprimantes.length }}</div>
                <div class="stats-label">Équipements</div>
              </div>
            </div>
            <div class="col-6">
              <div class="glass-card p-3">
                <div class="stats-number mb-1" style="font-size: 1.8rem;" 
                     [ngClass]="calculateDaysRemaining(contrat.dateFin) > 0 ? 'text-success' : 'text-danger'">
                  {{ calculateDaysRemaining(contrat.dateFin) > 0 ? calculateDaysRemaining(contrat.dateFin) : 0 }}
                </div>
                <div class="stats-label">Jours Restants</div>
              </div>
            </div>
          </div>
        </div>
      </div>

      <!-- Quick Actions -->
      <div class="card border-0 shadow-lg mb-4 glass-card">
        <div class="card-header border-0 bg-transparent">
          <h6 class="mb-0 fw-semibold text-dark">
            <i class="bi bi-lightning-charge me-2"></i>
            Actions Rapides
          </h6>
        </div>
        <div class="card-body">
          <div class="d-grid gap-3">
            <button class="btn btn-primary btn-enhanced">
              <i class="bi bi-calendar-plus me-2"></i>
              Planifier Intervention
            </button>
            <button class="btn btn-outline-info btn-enhanced">
              <i class="bi bi-file-earmark-text me-2"></i>
              Générer Rapport
            </button>
            <button class="btn btn-outline-success btn-enhanced">
              <i class="bi bi-chat-dots me-2"></i>
              Contacter Client
            </button>
          </div>
        </div>
      </div>

      <!-- Contract Timeline -->
      <div class="card border-0 shadow-lg glass-card">
        <div class="card-header border-0 bg-transparent">
          <h6 class="mb-0 fw-semibold text-dark">
            <i class="bi bi-clock-history me-2"></i>
            Chronologie du Contrat
          </h6>
        </div>
        <div class="card-body">
          <div class="timeline-enhanced">
            <div class="timeline-item-enhanced">
              <div class="timeline-marker-enhanced"></div>
              <div class="timeline-content-enhanced">
                <div class="d-flex align-items-center mb-2">
                  <div class="p-2 rounded-circle bg-success text-white me-3">
                    <i class="bi bi-play-circle"></i>
                  </div>
                  <div>
                    <h6 class="mb-1 fw-semibold text-success">Début du Contrat</h6>
                    <small class="text-muted">{{ formatDate(contrat.dateDebut) }}</small>
                  </div>
                </div>
                <p class="small text-muted mb-0">Le contrat a été activé et mis en vigueur</p>
              </div>
            </div>
            
            <div class="timeline-item-enhanced" *ngIf="getProgressPercentage(contrat.dateDebut, contrat.dateFin) > 0">
              <div class="timeline-marker-enhanced" style="background: linear-gradient(135deg, #17a2b8, #138496);"></div>
              <div class="timeline-content-enhanced">
                <div class="d-flex align-items-center mb-2">
                  <div class="p-2 rounded-circle bg-info text-white me-3">
                    <i class="bi bi-hourglass-split"></i>
                  </div>
                  <div>
                    <h6 class="mb-1 fw-semibold text-info">État Actuel</h6>
                    <small class="text-muted">{{ getCurrentDate() }}</small>
                  </div>
                </div>
                <p class="small text-muted mb-0">
                  Contrat en cours - {{ getProgressPercentage(contrat.dateDebut, contrat.dateFin) }}% accompli
                </p>
              </div>
            </div>
            
            <div class="timeline-item-enhanced">
              <div class="timeline-marker-enhanced" [style.background]="calculateDaysRemaining(contrat.dateFin) > 0 ? 'linear-gradient(135deg, #ffc107, #e0a800)' : 'linear-gradient(135deg, #dc3545, #c82333)'"></div>
              <div class="timeline-content-enhanced">
                <div class="d-flex align-items-center mb-2">
                  <div class="p-2 rounded-circle text-white me-3" [ngClass]="calculateDaysRemaining(contrat.dateFin) > 0 ? 'bg-warning' : 'bg-danger'">
                    <i [ngClass]="calculateDaysRemaining(contrat.dateFin) > 0 ? 'bi-calendar-check' : 'bi-calendar-x'"></i>
                  </div>
                  <div>
                    <h6 class="mb-1 fw-semibold" [ngClass]="calculateDaysRemaining(contrat.dateFin) > 0 ? 'text-warning' : 'text-danger'">
                      {{ calculateDaysRemaining(contrat.dateFin) > 0 ? 'Fin du Contrat' : 'Contrat Expiré' }}
                    </h6>
                    <small class="text-muted">{{ formatDate(contrat.dateFin) }}</small>
                  </div>
                </div>
                <p class="small text-muted mb-0">
                  {{ calculateDaysRemaining(contrat.dateFin) > 0 ? 'Date de fin prévue du contrat' : 'Le contrat a expiré' }}
                </p>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>
